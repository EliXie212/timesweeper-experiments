IDS, = glob_wildcards("bams/sorted/{id}.sorted.bam")

rule all:
    input:
        expand("bams/stats/{id}.stats", id=IDS),
        expand("vcfs/calls/stats/{id}.stats", id=IDS),
        "vcfs/merged/ts_merged.filtered.calls.vcf.gz",
        "vcfs/merged/ts_merged.filtered.stats",
        "vcf-multiqc/multiqc_report.html",
        "bam-multiqc/multiqc_report.html"

rule bamstats:
    input:
        "bams/sorted/{id}.sorted.bam"
    output:
        "bams/stats/{id}.stats"
    threads: 1
    shell:
        """
        samtools stats {input} > {output}
        """
rule call_vars:
    input:
        "vcfs/raw/{id}.vcf.gz"
    output:
        "vcfs/calls/{id}.called.vcf.gz"
    threads: 4
    shell:
        """
        bcftools call -m --threads {threads} {input} | \
        bcftools filter -Oz -o {output} -i '%QUAL>20'
        """

rule index:
    input:
        "vcfs/calls/{id}.called.vcf.gz"
    output:
        "vcfs/calls/{id}.called.vcf.gz.csi"
    threads: 2
    shell:
        """
        bcftools index --threads {threads} {input}
        """
    
rule vcfstats:
    input:
        "vcfs/calls/{id}.called.vcf.gz"
    output:
        "vcfs/calls/stats/{id}.stats"
    shell:
        """
        bcftools stats {input} > {output}
        """

rule merge:
    input:
        vcfs = expand("vcfs/calls/{id}.called.vcf.gz", id=IDS),
        indexes = expand("vcfs/calls/{id}.called.vcf.gz.csi", id=IDS),
    output:
        "vcfs/merged/ts_merged.calls.vcf.gz"
    threads: workflow.cores
    shell:
        """
        bcftools merge -Oz --threads {threads} --force-samples {input.vcfs} > {output}
        """

rule filter:
    input:
        "vcfs/merged/ts_merged_missing.calls.vcf.gz"
    output:
        "vcfs/merged/ts_merged_missing.filtered.calls.vcf.gz"
    threads: workflow.cores
    shell:
        """
        bcftools view -Oz -i 'F_MISSING<0.5' {input} > {output}
        """

rule merged_vcfstats:
    input:
        "vcfs/merged/ts_merged.calls.vcf.gz"
    output:
        "vcfs/merged/ts_merged.raw.stats"
    threads: 1
    shell:
        """
        bcftools stats {input} > {output}
        """

rule filtered_vcfstats:
    input:
        "vcfs/merged/ts_merged.filtered.calls.vcf.gz",
    output:
        "vcfs/merged/ts_merged.filtered.stats"
    threads: workflow.cores
    shell:
        """
        bcftools stats --threads {threads} {input} > {output}
        """

rule multiqc:
    output:
        "vcf-multiqc/multiqc_report.html",
        "bam-multiqc/multiqc_report.html"
    shell:
        """
        multiqc vcfs/calls/ -o vcf-multiqc
        multiqc bams/sorted/ -o bam-multiqc
        """